name: "CI/CD Pipeline"

# Orchestrator Workflow
# 1. Validation (Check + Lint) - Always runs
# 2. Build - Runs on tags or manual dispatch
# 3. Release & Deploy - Runs on tags/manual, uses build artifacts

on:
  push:
    branches: [ main, develop, feature/* ]
    tags:
      - "v*"
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:


jobs:
  # 1ï¸âƒ£ Validation Stage
  validation:
    name: "ğŸ” Validation"
    uses: ./.github/workflows/validation.yml

  # 2ï¸âƒ£ Build Stage
  build:
    name: "ğŸ—ï¸ Build"
    needs: validation
    # Run on tags OR manual dispatch
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    uses: ./.github/workflows/build.yml
    secrets: inherit

  # 3ï¸âƒ£ Release & Deploy Stage
  release:
    name: "ğŸš€ Release & Deploy"
    needs: build
    # Run ONLY on tags (even if manual dispatch triggered build, typical release is tag-based)
    if: startsWith(github.ref, 'refs/tags/v')
    uses: ./.github/workflows/release.yml
    secrets: inherit
    permissions:
      contents: write
